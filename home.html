<!doctype html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoinGaze</title>
    <link rel="shortcut icon" href="/assets/favicon.png" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles.css">
</head>

<body>

    <!-- Navbar start -->
    <header class="header-main">
        <nav class="nav-bar" aria-label="Global">
            <div class="nav-bar-content flex items-center justify-between p-2 lg:px-8">
                <div class="flex lg:flex-1">

                    <!-- Hamburger button -->
                    <button id="menu-toggle" class="hamburger text-white p-2">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2"
                                d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>

                    <p class="title">CoinGaze</p>

                </div>


                <div class="lg:flex lg:gap-x-12">
                    <a href="#" class="text-m navbar-text">Home</a>
                    <a href="#market-nav-placeholder" class="text-m navbar-text">Market</a>
                    <a href="https://www.forbes.com/advisor/investing/cryptocurrency/" target="_blank" class="text-m navbar-text">Learn</a>
                </div>

                <!-- Dropdown -->
                <div class="lg:flex lg:flex-1 flex lg:justify-end">
                    <p class="text-m navbar-text-currency mr-3">Currency:</p>
                    <div class="relative inline-block text-left">
                        <div>
                            <button type="button"
                                class="inline-flex w-full justify-center gap-x-1.5 rounded-md px-3 py-2 text-sm text-white dd-button"
                                id="menu-button" aria-expanded="true" aria-haspopup="true">
                                <p id="menu-button-text">USD</p>
                                <svg class="-mr-1 h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor"
                                    aria-hidden="true">
                                    <path fill-rule="evenodd"
                                        d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z"
                                        clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>

                        <!-- Dropdown Menu -->
                        <div id="menu-dropdown"
                            class="absolute right-0 z-10 mt-2 w-full origin-top-right rounded-md bg-white shadow-lg hidden"
                            role="menu" aria-orientation="vertical" aria-labelledby="menu-button" tabindex="-1">
                            <div class="py-1" role="none">

                                <a href="#" class="dropdown text-gray-700 block px-4 py-2 text-sm" role="menuitem"
                                    tabindex="-1" id="usd" onclick="currencyChanger('USD')">USD</a>
                                <a href="#" class=" dropdown text-gray-700 block px-4 py-2 text-sm" role="menuitem"
                                    tabindex="-1" id="nzd" onclick="currencyChanger('NZD')">NZD</a>
                                <a href="#" class="dropdown text-gray-700 block px-4 py-2 text-sm" role="menuitem"
                                    tabindex="-2" id="aud" onclick="currencyChanger('AUD')">AUD</a>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Dropdown ends -->
            </div>
        </nav>
    </header>
    <!-- Navbar end -->

    <!-- Mobile Navigation -->
    <div class="mobile-nav" id="mobile-nav">
        <svg id="close-nav" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="close-window">
            <path d="M18 6l-12 12"></path>
            <path d="M6 6l12 12"></path>
        </svg>
        <ul class="mobile-nav-items">
            <li><a class="mobile-link" href="#">Home</a></li>
            <li><a class="mobile-link" href="#market-nav-placeholder">Market</a></li>
            <li><a class="mobile-link" href="https://www.forbes.com/advisor/investing/cryptocurrency/" target="_blank">Learn</a></li>
        </ul>
    </div>

    <!-- Hero section start -->
    <div class="mycontainer">

        <section class="hero flex justify-between">
            <p class="hero-heading">Keep track of<br> your crypto<br> with
                CoinGaze.<br>
                <span class="button-section"><a href="#market-nav-placeholder" class="buttons text-white" type="button">
                        Start
                    </a>
                    <a href="https://www.forbes.com/advisor/investing/cryptocurrency/" target="_blank" class="buttons-offcolor text-white ml-1" type="button">
                        Learn
                    </a></span>
            </p>
            <img id="phone" class="phone" src="/assets/Phone.png" alt="phone">
        </section>
        <!-- Hero section end -->

        <!-- Using this template to populate the 'Top 4' -->
        <template id="top-four">
            <div class="card flex flex-col items-center">
                <img class="crypto-logo" src="" alt="">
                <div class="card-body">
                    <span class="flex flex-row items-end">
                        <p class="crypto-name mt-2"></p>
                        <p class="crypto-24h ml-2"></p>
                    </span>
                    <p class="crypto-price"></p>
                </div>
            </div>
        </template>

        <!-- Top 4 crypto gets populated here -->
        <div class="hero-crypto-display">
            <span class="crypto-top-4 flex flex-row justify-between" id="crypto-top-4"></span>
        </div>
        <!-- Top 4 crypto bar ends-->

        <!-- Only used for Navigation purposes -->
        <div id="market-nav-placeholder" class="market-nav-placeholder"></div>


        <!-- Market section -->
        <div id="market-section" class="market-section">
            <span id="market-top-bar" class="flex flex-row items-center">
                <p class="market-title mb-3">Market Insights</p><img id="coinstack" class="coinstack ml-5"
                    src="/assets/coinstack.png">
            </span>
            <div class="market-top-bar text-xl flex flex-row">
                <p class="table-item-name">Coin</p>
                <p class="table-item-price">Price</p>
                <p class="table-item-24h">24H</p>
                <p class="table-item-end">Mkt Cap</p>
            </div>

            <!-- This template to populate the Market section. -->
            <template id="market-table">
                <div class="row">
                    <span class="flex flex-row items-center border-b-solid border-b-2 border-r-2 border-l-2 p-2">
                        <span class="flex flex-row items-center table-item"> <img class="logo-small" src="">
                            <p class="crypto-name-table ml-3">Bitcoin</p>
                        </span>
                        <p class="crypto-price-table table-item">$26538</p>
                        <p class="crypto-24h-table table-item">0.20%</p>
                        <p class="crypto-mktcap-table table-item-end">$517357646580</p>
                    </span>
                </div>
            </template>

            <!-- Market-section gets populated here -->
            <div id="market-rows" class="market-rows mb-8">
            </div>

            <!-- Market navigation buttons -->
            <div class="market-navigation flex justify-center gap-5 text-lg mb-5">
                <a href="#market-nav-placeholder" class="market-nav-btn" onclick="marketPageNumber(0,10)">1</a>
                <a href="#market-nav-placeholder" class="market-nav-btn" onclick="marketPageNumber(10,20)">2</a>
                <a href="#market-nav-placeholder" class="market-nav-btn" onclick="marketPageNumber(20,30)">3</a>
                <a href="#market-nav-placeholder" class="market-nav-btn" onclick="marketPageNumber(30,40)">4</a>
                <a href="#market-nav-placeholder" class="market-nav-btn" onclick="marketPageNumber(40,50)">5</a>
            </div>

        </div>
    </div>

    <!-- Script -->

    <script>

        /* Mobile Navigation and Hamburger-menu logic. */

        let hamburgerClicked = false; // Boolean condition to toggle when the Hamburger button has been clicked.

        const hamburgerMenu = document.getElementById('menu-toggle');
        const mobileNav = document.getElementById('mobile-nav');
        const closeNav = document.getElementById('close-nav');
        const mobileLinks = document.querySelectorAll('.mobile-link');

        closeNav.addEventListener('click', () => {
            mobileNav.style.left = '-100%'; // Close the navigation when the 'X' svg is pressed.
            hamburgerClicked = false;
        });


        /* Looping through the links in the Mobile Navigation and applying an Event listener to each item. */
        mobileLinks.forEach(link => {
            link.addEventListener('click', () => {
                mobileNav.style.left = '-100%'; // Close the navigation when any of the navigation links are pressed.
                hamburgerClicked = false;
            });
        });

        // Function to open the mobile navigation
        hamburgerMenu.addEventListener('click', () => {
            if (hamburgerClicked) {
                mobileNav.style.left = '-100%';
                hamburgerClicked = false;
            } else {
                mobileNav.style.left = '0'; // Slide the navigation out
                hamburgerClicked = true;
            }
        });


        // Function to toggle Tailwind's "hidden" class on all the dropdown elements in the Navigation bar.
        document.addEventListener("DOMContentLoaded", function () {
            const menuButton = document.getElementById("menu-button");
            const usdButton = document.getElementById("usd");
            const nzdButton = document.getElementById("nzd");
            const audButton = document.getElementById("aud");
            const dropdown = document.getElementById("menu-dropdown");

            function toggleDropdown() {
                dropdown.classList.toggle("hidden");
            }
            menuButton.addEventListener("click", toggleDropdown);
            usdButton.addEventListener("click", toggleDropdown);
            nzdButton.addEventListener("click", toggleDropdown);
            audButton.addEventListener("click", toggleDropdown);
            // Event-listener needed for the buttons to toggle it.
        });

        let selectedCurrency = 'USD'; // Sets the current currency.

        // Button-click function for the Currency dropdown.
        function currencyChanger(currency) {
            selectedCurrency = currency; // Set the selected currency
            document.getElementById('menu-button-text').innerText = currency;
            localStorage.removeItem('cryptoData'); // Clear the cache
            document.querySelector('#crypto-top-4').innerHTML = ""; // Resetting the display of Top 4.
            document.querySelector('#market-rows').innerHTML = ""; // Resetting the display of the Market section.
            fetchCrypto(selectedCurrency); // Fetch data with the new Currency
        }

        let selectedRange = [0, 10]; // Default value of the range for the Market page (1-10 on page 1)

        // Display function for the Market-section pages.
        function marketPageNumber(a, b) {

            setTimeout(() => {
                selectedRange = [a, b];
                document.querySelector('#market-rows').innerHTML = "";
                /* Using the same logic as in the fetchCrypto function. Checks if there's cached data that can be used rather than making
                another request on the API. */
                if (cachedData && cachedTimestamp && (currentTime - cachedTimestamp < CACHE_EXPIRY)) {
                    crypto = JSON.parse(cachedData);
                    populateMarketTable(crypto, selectedRange);
                } else {
                    document.querySelector('#crypto-top-4').innerHTML = "";
                    fetchCrypto(selectedCurrency);
                }
            }, 500);
        }

        // Declaring global variables needed for the Cache to work.
        let crypto;
        let cachedData;
        let cachedTimestamp;
        let currentTime;
        
        /* The main function that permfors a get-request on the API and calls the two functions that populates the website. */
        async function fetchCrypto(selectedCurrency) {

            /* Saving the data as a local cache for 20 seconds to prevent hitting the rate limit of Coingecko's API.
             Will check if there is cached data already, and how long it's been since the last data was cached compared with currentTime. */
            cachedData = localStorage.getItem('cryptoData');
            cachedTimestamp = localStorage.getItem('cryptoTimestamp');
            currentTime = new Date().getTime();


            if (cachedData && cachedTimestamp && (currentTime - cachedTimestamp < CACHE_EXPIRY)) {
                // Use cached data
                crypto = JSON.parse(cachedData);
                populateTopFour(crypto);
                populateMarketTable(crypto, selectedRange);
            } else {
                // Fetch fresh data from the API
                const response = await fetch(`https://api.coingecko.com/api/v3/coins/markets?vs_currency=${selectedCurrency}&include_market_cap=true&include_24hr_change=true&order=market_cap_desc&per_page=50`);
                const crypto = await response.json();

                // Caching the data
                localStorage.setItem('cryptoData', JSON.stringify(crypto));
                localStorage.setItem('cryptoTimestamp', currentTime);

                // Populate the data
                populateTopFour(crypto);
                populateMarketTable(crypto, selectedRange);
                return crypto;
            }
        }

        // Function to populate the "Top 4" used in the Hero section.
        function populateTopFour(crypto) {

            crypto = crypto.slice(0, 4);
            // Only want the first 4 items here.

            const template = document.getElementById("top-four");

            crypto.forEach(element => {
                const clonedTemplate = document.importNode(template.content, true);

                let number = element.current_price.toFixed(2);
                let priceFormatted = parseFloat(number).toLocaleString('currency', { style: 'decimal', maximumFractionDigits: 2, minimumFractionDigits: 2 });
                // Somewhat tricky solution to keep the two digits but also gaining the formatting from .toLocaleString. It works, however.

                clonedTemplate.querySelector('.crypto-logo').src = element.image;
                clonedTemplate.querySelector('.crypto-logo').alt = element.name;
                clonedTemplate.querySelector('.crypto-name').innerText = element.name;
                if (element.price_change_percentage_24h < 0) {
                    clonedTemplate.querySelector('.crypto-24h').innerHTML = `${element.price_change_percentage_24h.toFixed(2)}%`;
                    clonedTemplate.querySelector('.crypto-24h').style = 'color:red;'
                    // Displaying negative data in red.
                } else {
                    clonedTemplate.querySelector('.crypto-24h').innerHTML = `${element.price_change_percentage_24h.toFixed(2)}%`;
                    clonedTemplate.querySelector('.crypto-24h').style = 'color:#50C878;'
                    // Displaying positive data in green.
                }
                clonedTemplate.querySelector('.crypto-price').innerText = `$${priceFormatted}`;

                document.querySelector('#crypto-top-4').appendChild(clonedTemplate);
            });
        }

        // Function to format big numbers into a smaller one with a suffix. Needed for market cap values.
        function formatBigNumber(mktCap) {

            const numberMktCap = Number(mktCap);

            if (numberMktCap >= 1.0e9) {
                return (numberMktCap / 1.0e9).toFixed(2).toString() + "B"; // Billions.
            } else if (numberMktCap >= 1.0e6) {
                return (numberMktCap / 1.0e6).toFixed(2).toString() + "M"; // Millions.
            } else {
                return numberMktCap.toString(); // Default.
            }
        }

        // Function to populate the Market-section.
        function populateMarketTable(crypto, selectedRange) {

            crypto = crypto.slice(selectedRange[0], selectedRange[1]);

            const template = document.getElementById("market-table");


            crypto.forEach(element => {
                const clonedTemplate = document.importNode(template.content, true);

                let number = element.current_price.toFixed(2);
                let priceFormatted = parseFloat(number).toLocaleString('currency', { style: 'decimal', maximumFractionDigits: 2, minimumFractionDigits: 2 });
                // Formatting both the market cap, and the price.


                clonedTemplate.querySelector('.logo-small').src = element.image;
                clonedTemplate.querySelector('.logo-small').alt = element.symbol;
                clonedTemplate.querySelector('.crypto-name-table').innerText = element.symbol.toUpperCase();
                if (element.price_change_percentage_24h < 0) {
                    clonedTemplate.querySelector('.crypto-24h-table').innerHTML = `${element.price_change_percentage_24h.toFixed(2)}%`;
                    clonedTemplate.querySelector('.crypto-24h-table').style = 'color:red;'
                    // Displaying negative data in red.
                } else {
                    clonedTemplate.querySelector('.crypto-24h-table').innerHTML = `${element.price_change_percentage_24h.toFixed(2)}%`;
                    clonedTemplate.querySelector('.crypto-24h-table').style = 'color:#50C878;'
                    // Displaying positive data in green.
                }

                clonedTemplate.querySelector('.crypto-price-table').innerText = `$${priceFormatted}`;
                clonedTemplate.querySelector('.crypto-mktcap-table').innerText = `$${formatBigNumber(element.market_cap)}`;

                document.querySelector('#market-rows').appendChild(clonedTemplate);
            });
        }

        const CACHE_EXPIRY = 20000; // Cache expiry time set to 20 seconds to prevent hitting the rate limit.

        setTimeout(() => {
            fetchCrypto(selectedCurrency); // Using a time-out to prevent hitting the rate limit.
        }, 500);

    </script>
</body>
</html>